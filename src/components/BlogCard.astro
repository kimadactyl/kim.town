---
import { SITE_BASE } from '@/consts'
import FormattedDate from './FormattedDate.astro'
import { Image } from 'astro:assets'
import { Icon } from 'astro-icon/components'

const { post } = Astro.props

const isExternal = !!post.data.externalUrl
const href = isExternal ? post.data.externalUrl : `${SITE_BASE}/writing/${post.id}/`

// Extract domain from external URL for display
const getDomain = (url: string) => {
	try {
		return new URL(url).hostname.replace('www.', '')
	} catch {
		return ''
	}
}
const externalDomain = isExternal ? getDomain(post.data.externalUrl) : ''
---

<a
	href={href}
	target={isExternal ? '_blank' : undefined}
	rel={isExternal ? 'noopener noreferrer' : undefined}
	class:list={[
		"blog-card flex flex-col gap-4 pb-8 h-full group transition-all relative",
		isExternal && "blog-card--external"
	]}
>
	{
		post.data.heroImage && (
			<div class="relative overflow-hidden rounded-xl">
				<Image
					src={post.data.heroImage}
					alt={post.data.title}
					class="object-cover aspect-video w-full transition-transform duration-500 group-hover:scale-105"
				/>
			</div>
		)
	}

	{/* External post indicator - subtle top accent bar */}
	{isExternal && (
		<div class="external-indicator flex items-center gap-2 text-xs font-medium tracking-wide uppercase text-primary dark:text-primary-dark">
			<span class="inline-block w-8 h-px bg-current"></span>
			<span class="flex items-center gap-1.5">
				<Icon name="mdi:arrow-top-right" class="w-3.5 h-3.5" />
				{externalDomain}
			</span>
		</div>
	)}

	<h4
		class="text-2xl font-semibold group-hover:text-primary dark:group-hover:text-primary-dark transition-colors leading-snug"
	>
		{post.data.title}
	</h4>

	<p class="line-clamp-3 opacity-75 leading-relaxed">
		{post.data.description}
	</p>

	<div class="flex items-center gap-3 mt-auto pt-2 border-t border-foreground/10 dark:border-foreground-dark/10">
		<p class="uppercase text-xs tracking-wider opacity-60">
			<FormattedDate date={post.data.pubDate} />
		</p>
		{isExternal && (
			<span class="ml-auto text-xs opacity-50 flex items-center gap-1">
				Opens externally
				<Icon name="mdi:open-in-new" class="w-3 h-3" />
			</span>
		)}
	</div>
</a>

<style>
	.blog-card--external {
		border-left: 2px solid color-mix(in srgb, var(--color-primary) 40%, transparent);
		padding-left: 1rem;
	}

	:global(.dark) .blog-card--external {
		border-left-color: color-mix(in srgb, var(--color-primary-dark) 40%, transparent);
	}

	.external-indicator {
		animation: fadeSlideIn 0.3s ease-out;
	}

	@keyframes fadeSlideIn {
		from {
			opacity: 0;
			transform: translateX(-8px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}
</style>
