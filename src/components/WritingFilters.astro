---
interface Props {
	sources: { name: string; count: number }[]
	tags: { name: string; count: number }[]
}

const { sources, tags } = Astro.props

// Source display names
const sourceLabels: Record<string, string> = {
	alliscalm: 'All Is Calm',
	gfsc: 'GFSC Studio',
	kimtown: 'Kim Town',
	'gfsc-community': 'GFSC Community',
	cassowary: 'Cassowary',
	resistancelab: 'Resistance Lab',
}

const totalPosts = sources.reduce((sum, s) => sum + s.count, 0)
---

<div class="writing-filters" id="writing-filters">
	<!-- Collapsed Header -->
	<button class="filter-header" id="filter-toggle">
		<div class="filter-header-content">
			<svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
			</svg>
			<span class="filter-title">Filter posts</span>
			<span class="filter-summary" id="filter-summary">{totalPosts} posts</span>
		</div>
		<svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<polyline points="6 9 12 15 18 9" />
		</svg>
	</button>

	<!-- Expandable Filter Content -->
	<div class="filter-content" id="filter-content">
		<!-- Source Filter Section -->
		<div class="filter-section">
			<h3 class="filter-label">Source</h3>
			<div class="filter-pills" id="source-filters">
				<button class="filter-pill active" data-source="all">
					<span class="pill-text">All</span>
				</button>
				{
					sources.map((source) => (
						<button class="filter-pill" data-source={source.name}>
							<span class="pill-text">{sourceLabels[source.name] || source.name}</span>
							<span class="pill-count">{source.count}</span>
						</button>
					))
				}
			</div>
		</div>

		<!-- Tag Filter Section -->
		<div class="filter-section">
			<h3 class="filter-label">Topics</h3>
			<div class="filter-pills" id="tag-filters">
				<button class="filter-pill active" data-tag="all">
					<span class="pill-text">All</span>
				</button>
				{
					tags.map((tag) => (
						<button class="filter-pill" data-tag={tag.name}>
							<span class="pill-text">{tag.name.replace(/-/g, ' ')}</span>
							<span class="pill-count">{tag.count}</span>
						</button>
					))
				}
			</div>
		</div>

		<!-- Clear button -->
		<button class="clear-filters" id="clear-filters">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<line x1="18" y1="6" x2="6" y2="18" />
				<line x1="6" y1="6" x2="18" y2="18" />
			</svg>
			Clear filters
		</button>
	</div>
</div>

<style>
	.writing-filters {
		margin-bottom: 1.5rem;
		border: 1px solid color-mix(in srgb, var(--color-foreground) 10%, transparent);
		border-radius: 8px;
		overflow: hidden;
	}

	:global(.dark) .writing-filters {
		border-color: color-mix(in srgb, var(--color-foreground-dark) 15%, transparent);
	}

	.filter-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		width: 100%;
		padding: 0.875rem 1rem;
		background: color-mix(in srgb, var(--color-foreground) 3%, transparent);
		border: none;
		cursor: pointer;
		transition: background 0.2s;
	}

	:global(.dark) .filter-header {
		background: color-mix(in srgb, var(--color-foreground-dark) 5%, transparent);
	}

	.filter-header:hover {
		background: color-mix(in srgb, var(--color-foreground) 6%, transparent);
	}

	:global(.dark) .filter-header:hover {
		background: color-mix(in srgb, var(--color-foreground-dark) 8%, transparent);
	}

	.filter-header-content {
		display: flex;
		align-items: center;
		gap: 0.6rem;
	}

	.filter-icon {
		width: 1rem;
		height: 1rem;
		opacity: 0.5;
	}

	.filter-title {
		font-size: 0.85rem;
		font-weight: 500;
	}

	.filter-summary {
		font-size: 0.8rem;
		opacity: 0.5;
		margin-left: 0.25rem;
	}

	.filter-summary.has-filters {
		color: var(--color-primary);
		opacity: 1;
		font-weight: 500;
	}

	:global(.dark) .filter-summary.has-filters {
		color: var(--color-primary-dark);
	}

	.chevron-icon {
		width: 1.1rem;
		height: 1.1rem;
		opacity: 0.4;
		transition: transform 0.25s ease;
	}

	.writing-filters.expanded .chevron-icon {
		transform: rotate(180deg);
	}

	.filter-content {
		display: none;
		padding: 1rem;
		border-top: 1px solid color-mix(in srgb, var(--color-foreground) 8%, transparent);
	}

	:global(.dark) .filter-content {
		border-top-color: color-mix(in srgb, var(--color-foreground-dark) 10%, transparent);
	}

	.writing-filters.expanded .filter-content {
		display: block;
		animation: slideDown 0.2s ease-out;
	}

	@keyframes slideDown {
		from {
			opacity: 0;
			transform: translateY(-8px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.filter-section {
		margin-bottom: 1rem;
	}

	.filter-section:last-of-type {
		margin-bottom: 1rem;
	}

	.filter-label {
		font-size: 0.65rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.12em;
		color: color-mix(in srgb, var(--color-foreground) 45%, transparent);
		margin-bottom: 0.6rem;
	}

	:global(.dark) .filter-label {
		color: color-mix(in srgb, var(--color-foreground-dark) 45%, transparent);
	}

	.filter-pills {
		display: flex;
		flex-wrap: wrap;
		gap: 0.4rem;
	}

	.filter-pill {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.3rem 0.7rem;
		font-size: 0.75rem;
		font-weight: 500;
		border: 1px solid color-mix(in srgb, var(--color-foreground) 12%, transparent);
		border-radius: 999px;
		background: transparent;
		color: color-mix(in srgb, var(--color-foreground) 65%, transparent);
		cursor: pointer;
		transition: all 0.15s ease;
		white-space: nowrap;
	}

	:global(.dark) .filter-pill {
		border-color: color-mix(in srgb, var(--color-foreground-dark) 18%, transparent);
		color: color-mix(in srgb, var(--color-foreground-dark) 65%, transparent);
	}

	.filter-pill:hover {
		border-color: var(--color-primary);
		color: var(--color-primary);
	}

	:global(.dark) .filter-pill:hover {
		border-color: var(--color-primary-dark);
		color: var(--color-primary-dark);
	}

	.filter-pill.active {
		border-color: var(--color-primary);
		background: var(--color-primary);
		color: var(--color-background);
	}

	:global(.dark) .filter-pill.active {
		border-color: var(--color-primary-dark);
		background: var(--color-primary-dark);
		color: var(--color-background-dark);
	}

	.pill-count {
		font-size: 0.6rem;
		opacity: 0.55;
		font-weight: 400;
	}

	.filter-pill.active .pill-count {
		opacity: 0.75;
	}

	.clear-filters {
		display: none;
		align-items: center;
		gap: 0.3rem;
		padding: 0.3rem 0.6rem;
		font-size: 0.7rem;
		font-weight: 500;
		color: color-mix(in srgb, var(--color-foreground) 45%, transparent);
		background: color-mix(in srgb, var(--color-foreground) 5%, transparent);
		border: none;
		border-radius: 4px;
		cursor: pointer;
		transition: all 0.15s;
	}

	:global(.dark) .clear-filters {
		color: color-mix(in srgb, var(--color-foreground-dark) 45%, transparent);
		background: color-mix(in srgb, var(--color-foreground-dark) 8%, transparent);
	}

	.clear-filters.visible {
		display: inline-flex;
	}

	.clear-filters:hover {
		color: var(--color-foreground);
		background: color-mix(in srgb, var(--color-foreground) 10%, transparent);
	}

	:global(.dark) .clear-filters:hover {
		color: var(--color-foreground-dark);
		background: color-mix(in srgb, var(--color-foreground-dark) 12%, transparent);
	}

	.clear-filters svg {
		width: 0.75rem;
		height: 0.75rem;
	}

	@media (max-width: 640px) {
		.filter-pills {
			gap: 0.35rem;
		}

		.filter-pill {
			padding: 0.28rem 0.6rem;
			font-size: 0.7rem;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const filtersContainer = document.getElementById('writing-filters')
		const filterToggle = document.getElementById('filter-toggle')
		const sourceFilters = document.getElementById('source-filters')
		const tagFilters = document.getElementById('tag-filters')
		const filterSummary = document.getElementById('filter-summary')
		const clearBtn = document.getElementById('clear-filters')
		const postsContainer = document.querySelector('.posts-grid-container')

		let activeSource = 'all'
		let activeTag = 'all'

		// Toggle filter panel
		filterToggle?.addEventListener('click', () => {
			filtersContainer?.classList.toggle('expanded')
		})

		// Filter posts
		function filterPosts() {
			const posts = postsContainer?.querySelectorAll('li') as NodeListOf<HTMLElement>
			let visibleCount = 0

			posts?.forEach((post) => {
				const postSource = post.dataset.source || ''
				const postTags = (post.dataset.tags || '').split(',')

				const matchesSource = activeSource === 'all' || postSource === activeSource
				const matchesTag = activeTag === 'all' || postTags.includes(activeTag)

				if (matchesSource && matchesTag) {
					post.style.display = ''
					post.style.animation = 'fadeIn 0.25s ease-out'
					visibleCount++
				} else {
					post.style.display = 'none'
				}
			})

			// Update summary
			const hasActiveFilters = activeSource !== 'all' || activeTag !== 'all'
			if (filterSummary) {
				filterSummary.textContent = hasActiveFilters
					? `${visibleCount} of ${posts?.length} posts`
					: `${posts?.length} posts`
				filterSummary.classList.toggle('has-filters', hasActiveFilters)
			}

			// Show/hide clear button
			clearBtn?.classList.toggle('visible', hasActiveFilters)
		}

		// Handle source filter clicks
		sourceFilters?.addEventListener('click', (e) => {
			const target = (e.target as HTMLElement).closest('.filter-pill') as HTMLElement
			if (!target) return

			sourceFilters.querySelectorAll('.filter-pill').forEach((p) => p.classList.remove('active'))
			target.classList.add('active')
			activeSource = target.dataset.source || 'all'
			filterPosts()
		})

		// Handle tag filter clicks
		tagFilters?.addEventListener('click', (e) => {
			const target = (e.target as HTMLElement).closest('.filter-pill') as HTMLElement
			if (!target) return

			tagFilters.querySelectorAll('.filter-pill').forEach((p) => p.classList.remove('active'))
			target.classList.add('active')
			activeTag = target.dataset.tag || 'all'
			filterPosts()
		})

		// Clear filters
		clearBtn?.addEventListener('click', () => {
			activeSource = 'all'
			activeTag = 'all'

			sourceFilters?.querySelectorAll('.filter-pill').forEach((p, i) => {
				p.classList.toggle('active', i === 0)
			})
			tagFilters?.querySelectorAll('.filter-pill').forEach((p, i) => {
				p.classList.toggle('active', i === 0)
			})

			filterPosts()
		})
	})
</script>
